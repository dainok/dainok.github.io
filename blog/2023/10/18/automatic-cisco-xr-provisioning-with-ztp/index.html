<!doctype html><html lang=en><head><meta name=google-site-verification content="NTPifZ1gNpp6HSoC60ErvHiUUor86ZXg4yHtlpk9lwU"><title>Andrea Dainese > Automatic Cisco XR provisioning with ZTP</title><meta charset=utf-8><meta name=author content="Andrea Dainese"><meta name=description content="This article explores how to optimize the provisioning of a hundred Cisco XR devices so that they are configured with minimal human intervention. Depending on the context, the devices might be shipped directly from the factory and configured automatically on-site, or more likely, they could be automatically configured in a lab environment, verified, and then shipped for installation."><meta name=generator content="Hugo 0.115.3"><meta name=“robots” content="“noarchive”"><meta name=“robots” content="“notranslate”"><meta name=robots content="noimageindex"><meta property="og:title" content="Automatic Cisco XR provisioning with ZTP"><meta property="og:description" content="This article explores how to optimize the provisioning of a hundred Cisco XR devices so that they are configured with minimal human intervention. Depending on the context, the devices might be shipped directly from the factory and configured automatically on-site, or more likely, they could be automatically configured in a lab environment, verified, and then shipped for installation."><meta property="og:type" content="article"><meta property="og:url" content="https://www.adainese.it/blog/2023/10/18/automatic-cisco-xr-provisioning-with-ztp/"><meta property="og:image" content="https://www.adainese.it/images/vendors/cisco.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-10-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-18T00:00:00+00:00"><meta property="og:site_name" content="Andrea Dainese"><meta name=twitter:card content="summary"><meta name=twitter:site content="@adainese"><meta name=twitter:image content="https://www.adainese.it/images/vendors/cisco.png"><meta name=twitter:title content="Andrea Dainese > Automatic Cisco XR provisioning with ZTP"><meta name=twitter:description content="This article explores how to optimize the provisioning of a hundred Cisco XR devices so that they are configured with minimal human intervention. Depending on the context, the devices might be shipped directly from the factory and configured automatically on-site, or more likely, they could be automatically configured in a lab environment, verified, and then shipped for installation."><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed for blog" href=/blog/index.xml><link rel=dns-prefetch href=https://www.googletagmanager.com><link href=https://www.googletagmanager.com rel=preconnect crossorigin><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=stylesheet type=text/css href=/plugins/fontawesome/css/all.min.css><link rel=stylesheet type=text/css href=/plugins/fancybox/jquery.fancybox.min.css><link rel=stylesheet type=text/css href=/fonts/opensans/opensans.css><link rel=stylesheet href=/css/style.min.db8a68dfac8ad6ed301e5f04872a83daee269833ef371fd9ec9475b745de14e5.css integrity="sha256-24po36yK1u0wHl8EhyqD2u4mmDPvNx/Z7JR1t0XeFOU="><link rel=stylesheet href=/css/print.min.a3802e6b39df8780c4980151b47550b34687a140e148c71342fb463b5322e6b1.css media=print integrity="sha256-o4Auaznfh4DEmAFRtHVQs0aHoUDhSMcTQvtGO1Mi5rE="></head><body><button type=button class="mobile-nav-toggle d-lg-none" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button><header id=header class=fixed-top><div class="container d-flex"><div class="logo mr-auto"><h1><a href=/#><span>Andrea</span> Dainese</a></h1></div><nav class="nav-menu d-none d-lg-block"><ul><li><a href=/#>Home</a></li><li><a href=/#about>About</a></li><li class=active><a href=/blog>Blog</a></li><li><a href=/categories>Categories</a></li><li><a href=https://www.patreon.com/adainese target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><form class="form-inline ml-2" action=/search><div class="input-group mb-3"><input id=search-query type=text class=form-control placeholder=Search... name=s aria-label="Search within the website" aria-describedby=basic-addon2><div class=input-group-append><button class="btn btn-outline-primary" type=submit aria-label=Search>
<i class="fa fa-search"></i></button></div></div></form></li></ul></nav></div></header><div id=page-header><div class=home-overlay></div><div class=container><div class=row><div class=col-12><div class="page-header-size text-center"><h1>Automatic Cisco XR provisioning with ZTP</h1></div></div></div></div></div><main id=main><div class=blogpost-single><div class=container><div class=row><div class="col-xs-12 col-sm-12 col-md-4 d-print-none"><div class=blogpost-nav><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Table of contents</h4><div class=toce><nav id=TableOfContents><ul><li><a href=#lab-network-configuration>Lab Network Configuration</a></li><li><a href=#configuration-setup>Configuration Setup</a></li><li><a href=#power-on-and-ztp-process-verification>Power On and ZTP Process Verification</a></li><li><a href=#development-and-troubleshooting>Development and Troubleshooting</a></li></ul></nav></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Latest posts</h4><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/12/frameworks-for-projects-with-cisco-aci-and-ndo/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/12/frameworks-for-projects-with-cisco-aci-and-ndo/>Frameworks for Projects with Cisco ACI and NDO</a><br><i class="fa fa-calendar"></i>
October 12, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/05/creating-an-interface-in-strata-cloud-manager/><img class="img-fluid rounded" src=/images/vendors/paloalto.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/05/creating-an-interface-in-strata-cloud-manager/>Creating an interface in Strata Cloud Manager</a><br><i class="fa fa-calendar"></i>
October 05, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/01/circular-dependencies-with-ndo/><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/01/circular-dependencies-with-ndo/>Circular Dependencies with NDO</a><br><i class="fa fa-calendar"></i>
October 01, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/09/28/modifying-an-object-in-strata-cloud-manager/><img class="img-fluid rounded" src=/images/vendors/paloalto.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/09/28/modifying-an-object-in-strata-cloud-manager/>Modifying an object in Strata Cloud Manager</a><br><i class="fa fa-calendar"></i>
September 28, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/09/24/from-single-site-to-multi-site-with-ndo/><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/09/24/from-single-site-to-multi-site-with-ndo/>From Single-Site to Multi-Site with NDO</a><br><i class="fa fa-calendar"></i>
September 24, 2025</p></div></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Categories</h4><div class=recent-post><div class=recent-post-img><a href=/categories/automation><img class="img-fluid rounded" src=/images/categories/automation.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/automation>Automation</a><br><i class="fa fa-blog"></i> 162 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/learning-paths><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/learning-paths>Learning paths</a><br><i class="fa fa-blog"></i> 126 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ciso><img class="img-fluid rounded" src=/images/categories/ciso.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ciso>CISO</a><br><i class="fa fa-blog"></i> 23 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/personal-security><img class="img-fluid rounded" src=/images/categories/personal-security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/personal-security>Personal Security</a><br><i class="fa fa-blog"></i> 22 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/security><img class="img-fluid rounded" src=/images/categories/security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/security>Security</a><br><i class="fa fa-blog"></i> 20 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/notes><img class="img-fluid rounded" src=/images/categories/notes.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/notes>Notes</a><br><i class="fa fa-blog"></i> 19 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/infrastructure><img class="img-fluid rounded" src=/images/categories/infrastructure.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/infrastructure>Infrastructure</a><br><i class="fa fa-blog"></i> 12 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ot-ics><img class="img-fluid rounded" src=/images/categories/ot-ics.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ot-ics>OT/ICS</a><br><i class="fa fa-blog"></i> 5 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/books><img class="img-fluid rounded" src=/images/categories/books.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/books>Books</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/unetlab><img class="img-fluid rounded" src=/images/categories/unetlab.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/unetlab>UNetLab</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/writeup><img class="img-fluid rounded" src=/images/categories/writeup.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/writeup>Write-up</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/osint><img class="img-fluid rounded" src=/images/categories/osint.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/osint>OSInt</a><br><i class="fa fa-blog"></i> 2 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/life><img class="img-fluid rounded" src=/images/categories/life.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/life>My life</a><br><i class="fa fa-blog"></i> 1 posts</p></div></div></div></div></div></div><div class="col-xs-12 col-sm-12 col-md-8 blogpost-container"><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><article><div class=blogpost-single-content><h2>Automatic Cisco XR provisioning with ZTP</h2><div class=blogpost-single-meta><div><i class="fa fa-user"></i> Andrea Dainese</div><div><i class="fa fa-calendar"></i>
October 18, 2023</div><div class=tag-meta><i class="fa fa-folder"></i>
<a href=/categories/automation/ title="All posts under Automation">Automation</a></div></div><div class=entry-content><div><a data-fancybox=gallery href=/images/vendors/cisco.webp><img class="img-fluid w-25 rounded shadow float-right" src=/images/vendors/cisco.webp alt="Post cover"></a></div><p>This article explores how to optimize the provisioning of a hundred <a href=https://www.cisco.com/go/iosxr title="Cisco XR">Cisco XR</a> devices so that they are configured with minimal human intervention. Depending on the context, the devices might be shipped directly from the factory and configured automatically on-site, or more likely, they could be automatically configured in a lab environment, verified, and then shipped for installation. We will rely on what is known as ZTP or Zero Touch Provisioning. The ZTP protocol allows configuring a factory-delivered device without any human intervention. ZTP is vendor-specific, and specifically on <a href=https://www.cisco.com/go/iosxr title="Cisco XR">Cisco XR</a> it requires:</p><ul><li>setting up a DHCP server to assign an IP address to the devices;</li><li>setting up a web server that generates configurations for each device;</li><li>powering on the devices so they can acquire an IP address via DHCP and reach the web server.</li></ul><p>In the scenario we envision, we set up a lab environment where the devices will be unboxed, automatically configured, packaged, and shipped to the final destination, where non-technical personnel will proceed with physical installation, network cable connections, and power-on. We assume no technical skills at remote sites and no ability to send technical personnel.</p><p>Let&rsquo;s delve into the details.</p><h2 id=lab-network-configuration>Lab Network Configuration</h2><p>We set up a lab environment using a Linux system with two network interfaces: the first <code>pnet0</code> will connect the system to the corporate network, and the second <code>pnet9</code> will be connected to a dedicated and isolated network. The devices to be configured will then be connected to a dedicated physical switch, whose gateway is the <code>pnet9</code> interface of the Linux system.</p><p><a data-fancybox=gallery href=/blog/2023/10/18/automatic-cisco-xr-provisioning-with-ztp/topology.png><img sizes="484 " srcset=/blog/2023/10/18/automatic-cisco-xr-provisioning-with-ztp/topology.png src=/blog/2023/10/18/automatic-cisco-xr-provisioning-with-ztp/topology.png alt="Lab topology" class="img-fluid rounded shadow mx-auto d-block text-center"></a></p><p>On the Linux system, we&rsquo;ll use <a href=https://thekelleys.org.uk/dnsmasq/doc.html title=Dnsmasq>Dnsmasq</a> configured as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>port=0
</span></span><span style=display:flex><span>interface=pnet9
</span></span><span style=display:flex><span>dhcp-range=169.254.1.0,169.254.1.253,30d
</span></span><span style=display:flex><span>dhcp-option=67,http://169.254.1.1:8080/ztp
</span></span><span style=display:flex><span>log-dhcp
</span></span></code></pre></div><p><a href=https://thekelleys.org.uk/dnsmasq/doc.html title=Dnsmasq>Dnsmasq</a> will serve the <code>169.254.1.0/24</code> network by assigning free IPs to clients and maintaining the assignment for 30 days. DHCP requests will include the URL for ZTP auto-configuration. DHCP requests will be logged via syslog, typically saved in <code>/var/log/syslog</code>.</p><h2 id=configuration-setup>Configuration Setup</h2><p>The web server, reachable at the configured address in the previous paragraph, must:</p><ul><li>make a Bash script available to all devices;</li><li>generate a specific configuration for each device;</li><li>make the correct configuration available to each device.</li></ul><p>We&rsquo;ll use <a href=https://flask.palletsprojects.com/ title=Flask>Flask</a> to create a small web application capable of dynamically generating configurations for each device. The application will respond to two URLs:</p><ul><li><code>/ztp</code> (GET), which will make the Bash script available to <a href=https://www.cisco.com/go/iosxr title="Cisco XR">Cisco XR</a> devices;</li><li><code>/config</code> (POST), which will make the specific configuration available to each device that must send its serial number.</li></ul><p>Once ready, the <a href=https://flask.palletsprojects.com/ title=Flask>Flask</a> application can be run with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>flask --app ztp run -p <span style=color:#ae81ff>8080</span> -h 169.254.1.1
</span></span></code></pre></div><p>Ensure the application is listening on the correct interface and that both URLs respond correctly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -q -O- http://169.254.1.1:8080/ztp
</span></span><span style=display:flex><span>wget -q -O- --post-data<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;serial=1234&#34;</span> http://169.254.1.1:8080/config
</span></span></code></pre></div><p>The <code>/ztp</code> URL will return text similar to the following, identical for all devices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>export CONFIG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/config.txt&#34;</span>
</span></span><span style=display:flex><span>source /pkg/bin/ztp_helper.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dmidecode | grep -m <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#34;Serial Number:&#34;</span> | awk <span style=color:#e6db74>&#39;{print $NF}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>PN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>xrcmd <span style=color:#e6db74>&#34;show inventory location 0/RP&#34;</span> | grep -m1 <span style=color:#e6db74>&#34;PID&#34;</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>RESULT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>wget -O- --post-data<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;serial=</span><span style=color:#e6db74>${</span>SN<span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;model=</span><span style=color:#e6db74>${</span>PN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>{{</span> url <span style=color:#f92672>}}</span> &gt; $CONFIG_FILE<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xrapply_with_reason <span style=color:#e6db74>&#34;Initial ZTP configuration&#34;</span> $CONFIG_FILE
</span></span></code></pre></div><p>After acquiring an IP via DHCP, the device will retrieve the described script. This script fetches the serial number (via <code>dmidecode</code>) and the model (via <code>show inventory</code>). Using these parameters, the device requests the second URL to use as its initial configuration.</p><p>The <code>/config</code> URL will return, based on the parameters passed in <code>POST</code>, the minimal configuration to make the device accessible via SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>username cisco
</span></span><span style=display:flex><span> group root-lr
</span></span><span style=display:flex><span> password 0 cisco
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>hostname device01
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>domain name example.com
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>vrf OOB address-family ipv4 unicast
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>router static vrf OOB address-family ipv4 unicast
</span></span><span style=display:flex><span>    0.0.0.0/0 169.254.1.1
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>interface MgmtEth0/0/CPU0/0
</span></span><span style=display:flex><span> vrf OOB
</span></span><span style=display:flex><span> ipv4 address 169.254.1.11 255.255.255.0
</span></span><span style=display:flex><span> no shutdown
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>ssh server v2
</span></span><span style=display:flex><span>ssh server vrf OOB
</span></span><span style=display:flex><span>!
</span></span><span style=display:flex><span>line default
</span></span><span style=display:flex><span> transport input ssh
</span></span></code></pre></div><h2 id=power-on-and-ztp-process-verification>Power On and ZTP Process Verification</h2><p>We&rsquo;ve reached the final but most critical step: powering on the device and verifying that the ZTP process works correctly. When starting a factory-new <a href=https://www.cisco.com/go/iosxr title="Cisco XR">Cisco XR</a> device, the ZTP process should start immediately after the cryptographic features legal notice:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>This product contains cryptographic features and is subject to United
</span></span><span style=display:flex><span>States and local country laws governing import, export, transfer and
</span></span><span style=display:flex><span>use. Delivery of Cisco cryptographic products does not imply third-party
</span></span><span style=display:flex><span>authority to import, export, distribute or use encryption. Importers,
</span></span><span style=display:flex><span>exporters, distributors and users are responsible for compliance with
</span></span><span style=display:flex><span>U.S. and local country laws. By using this product you agree to comply
</span></span><span style=display:flex><span>with applicable laws and regulations. If you are unable to comply with
</span></span><span style=display:flex><span>U.S. and local laws, return this product immediately.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A summary of U.S. laws governing Cisco cryptographic products may be
</span></span><span style=display:flex><span>found at:
</span></span><span style=display:flex><span>http://www.cisco.com/wwl/export/crypto/tool/stqrg.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you require further assistance please contact us by sending email to
</span></span><span style=display:flex><span>export@cisco.com.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:22.659 UTC: ifmgr[363]: %PKT_INFRA-LINK-3-UPDOWN : Interface MgmtEth0/RP0/CPU0/0, changed state to Down
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:22.661 UTC: ifmgr[363]: %PKT_INFRA-LINK-3-UPDOWN : Interface MgmtEth0/RP0/CPU0/0, changed state to Up
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:29.975 UTC: pyztp2[330]: %INFRA-ZTP-4-CONFIG_INITIATED : ZTP has initiated config load and commit operations
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:47.203 UTC: pyztp2[330]: %INFRA-ZTP-4-CONFIG_FINISHED : ZTP has finished config load and commit operations
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:53.034 UTC: pyztp2[330]: %INFRA-ZTP-4-PROVISIONING_COMPLETED : ZTP has successfully completed the provisioning
</span></span><span style=display:flex><span>RP/0/RP0/CPU0:Oct 18 08:11:59.329 UTC: pyztp2[330]: %INFRA-ZTP-4-EXITED : ZTP exited
</span></span></code></pre></div><p>If the ZTP process has worked correctly, the DHCP server will have assigned an IP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>2023-10-18T11:32:42.306237+02:00 kali dnsmasq-dhcp[3818]: 548912439 vendor class: PXEClient:Arch:00009:UNDI:003010:PID:N540-ACC-SYS
</span></span><span style=display:flex><span>2023-10-18T11:32:42.306699+02:00 kali dnsmasq-dhcp[3818]: 548912439 user class: xr-config
</span></span><span style=display:flex><span>2023-10-18T11:32:42.306856+02:00 kali dnsmasq-dhcp[3818]: 548912439 DHCPDISCOVER(pnet9) 40:14:82:c1:11:11
</span></span><span style=display:flex><span>2023-10-18T11:32:42.307036+02:00 kali dnsmasq-dhcp[3818]: 548912439 tags: pnet9
</span></span><span style=display:flex><span>2023-10-18T11:32:42.307208+02:00 kali dnsmasq-dhcp[3818]: 548912439 DHCPOFFER(pnet9) 169.254.1.11 40:14:82:c1:11:11
</span></span><span style=display:flex><span>2023-10-18T11:32:42.309068+02:00 kali dnsmasq-dhcp[3818]: 548912439 requested options: 1:netmask, 28:broadcast, 2:time-offset, 3:router,
</span></span><span style=display:flex><span>2023-10-18T11:32:42.309925+02:00 kali dnsmasq-dhcp[3818]: 548912439 requested options: 15:domain-name, 6:dns-server, 12:hostname,
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310094+02:00 kali dnsmasq-dhcp[3818]: 548912439 requested options: 67:bootfile-name, 43:vendor-encap, 143
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310183+02:00 kali dnsmasq-dhcp[3818]: 548912439 next server: 169.254.1.1
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310289+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  1 option: 53 message-type  2
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310366+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option: 54 server-identifier  169.254.1.1
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310433+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option: 51 lease-time  30d
</span></span><span style=display:flex><span>2023-10-18T11:32:42.310531+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option: 58 T1  15d
</span></span><span style=display:flex><span>2023-10-18T11:32:42.311451+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option: 59 T2  26d6h
</span></span><span style=display:flex><span>2023-10-18T11:32:42.311641+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option:  1 netmask  255.255.255.0
</span></span><span style=display:flex><span>2023-10-18T11:32:42.311775+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option: 28 broadcast  169.254.1.255
</span></span><span style=display:flex><span>2023-10-18T11:32:42.312018+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size:  4 option:  3 router  169.254.1.1
</span></span><span style=display:flex><span>2023-10-18T11:32:42.312554+02:00 kali dnsmasq-dhcp[3818]: 548912439 sent size: 25 option: 67 bootfile-name  http://169.254.1.1:8080/ztp
</span></span></code></pre></div><p>And the web server will have been contacted on the two URLs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> * Serving Flask app &#39;ztp&#39;
</span></span><span style=display:flex><span> * Debug mode: off
</span></span><span style=display:flex><span>WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
</span></span><span style=display:flex><span> * Running on http://169.254.1.1:8080
</span></span><span style=display:flex><span>Press CTRL+C to quit
</span></span><span style=display:flex><span>169.254.1.11 - - [18/Oct/2023 14:47:06] &#34;GET /ztp HTTP/1.1&#34; 200 -
</span></span><span style=display:flex><span>169.254.1.11 - - [18/Oct/2023 14:47:33] &#34;POST /config HTTP/1.1&#34; 200 -
</span></span></code></pre></div><p>At this point, the device will be reachable and ready to be configured using secondary automation systems like <a href=https://www.ansible.com/ title=Ansible>Ansible</a>.</p><h2 id=development-and-troubleshooting>Development and Troubleshooting</h2><p>The ZTP process described might appear simple and straightforward. However, it actually required several hours of testing to understand where and how the ZTP process was stalling. Let&rsquo;s see what tools we have for troubleshooting.</p><p>The ZTP status can be seen using the <code>show ztp status</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>State             : Terminated
</span></span><span style=display:flex><span>Current Fetcher   : No active fetcher
</span></span></code></pre></div><p>The ZTP process runs only if the router has factory settings; otherwise, it&rsquo;s skipped. If our router isn&rsquo;t factory-new, we have two options, both useful.</p><p>We can force the ZTP process from the command line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ztp initiate
</span></span></code></pre></div><p>Or we can, also from the command line, delete the configuration and reset ZTP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ztp clean
</span></span><span style=display:flex><span>configure terminal
</span></span><span style=display:flex><span>commit replace
</span></span><span style=display:flex><span>reload
</span></span></code></pre></div><p>ZTP process logs are stored on the device and can be viewed with <code>show ztp logging</code>. However, relying solely on these logs is inconvenient, considering that each boot takes several minutes. The best solution I found was to use the Bash available on <a href=https://www.cisco.com/go/iosxr title="Cisco XR">Cisco XR</a> devices and manually invoke the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -O- http://169.254.1.1:8080/ztp | bash -x
</span></span></code></pre></div><p>The above commands, typed from the console, open a Bash instance and execute the script made available by our developed application. Upon completion, the device should be configured as expected.</p></div></div></article><div class=clear></div></div></div></div></div></div></div></main><footer class=d-print-none><div class=footer-profile><div class=container id=contact><div class=row><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h2><span>Andrea</span> Dainese</h2></div><p>For information, collaborations, proposals, requests for help, donations, use one of the following channels; email is preferred.</p><div class=footer-icons><ul><li><a href=https://www.patreon.com/adainese title="Support me" target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.linkedin.com/in/adainese/ title="LinkedIn profile" target=_blank rel=noreferrer><i class="fab fa-linkedin-in"></i></a></li><li><a href=https://twitter.com/adainese title="Twitter profile" target=_blank rel=noreferrer><i class="fab fa-twitter"></i></a></li><li><a href=mailto:andrea@adainese.it title="Secure email" target=_blank rel=noreferrer><i class="fa fa-envelope"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 title=Podcast target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><a href=https://github.com/dainok/ title="GitHub repositories" target=_blank rel=noreferrer><i class="fab fa-github"></i></a></li><li><a href=/blog/index.xml title="RSS Feed" target=_blank><i class="fa fa-rss"></i></a></li></ul></div></div><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h4>Past events</h4></div><div class=footer-content><ul><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20240305-cisco-aci-automation.pdf title="View slides" target=_blank rel=noreferrer>SDN: Software Defined Now</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20231122-cybercrime.pdf title="View slides" target=_blank rel=noreferrer>Cybercrime</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220901-bgp-attack-scenarios.pdf title="View slides" target=_blank rel=noreferrer>BGP attack scenarios</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220317-approaching-ot-ics-security.pdf title="View slides" target=_blank rel=noreferrer>Approaching OT/ICS Security</a> (with <a href=https://www.festocte.it/eventi/industry_4_0/17-03-2022/webinar_la_cybersecurity_nelle_reti_di_fabbrica_P/>Festo Academy</a>)</li><li><a href="https://www.youtube.com/watch?v=sjQZghTkHkA" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200922-cyberrange.pdf title="View slides" target=_blank rel=noreferrer>Cyber Range: Analyzing a Cyber Attack</a></li><li><a href="https://www.youtube.com/watch?v=-PWtGaS28dk" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200623-clubitfvg-securing-ot-ics-plants.pdf title="View slides" target=_blank rel=noreferrer>Securing OT/ICS plants</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20190226-automation-for-cisco-netops.pdf title="View slides" target=_blank rel=noreferrer>Automation for Cisco NetOps</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181107-ciscon-sdn-complexity-and-tco-looking-for-an-easy-way.pdf title="View slides" target=_blank rel=noreferrer>SDN, Complexity and TCO</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181003-nts-protection-and-visibility-for-enterprise-networks.pdf title="View slides" target=_blank rel=noreferrer>Protection and visibility for enterprise networks</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20141106-festival-ict-why-wan-accelerators-still-matter.pdf title="View slides" target=_blank rel=noreferrer>Why WAN AccelerAtors (still) matter?</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20130918-festival-ict-designing-an-hybrid-data-center-infrastructure.pdf title="View slides" target=_blank rel=noreferrer>Designing an Hybrid Data Center Infrastructure</a></li></ul></div></div><div class="d-none d-md-block col-md-4"><div class=footer-head><h4>Competencies</h4></div><div class=footer-slides><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/security-125x100.webp alt="Incident Response"><div class=overlay>Incident Response</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/ciso-125x100.webp alt=Advisor><div class=overlay>Advisor</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/osint-125x100.webp alt="Open Source Intelligence (OSINT)"><div class=overlay>Open Source Intelligence (OSINT)</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/infrastructure-125x100.webp alt="System Integration / Automation"><div class=overlay>System Integration / Automation</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/writeup-125x100.webp alt="Training / Education / Cyber Range"><div class=overlay>Training / Education / Cyber Range</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/personal-security-125x100.webp alt="Personal Security"><div class=overlay>Personal Security</div></div></div></div></div></div></div></div><div class=footer-copyright><div class=container><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><div class=text-center>&copy; Copyright <strong>Andrea Dainese</strong>. All Rights Reserved</div><div class=text-center>Designed by <a href=https://bootstrapmade.com/ title=BootstrapMade target=_blank rel=noreferrer>BootstrapMade</a></div></div></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script>
<script src=/plugins/bootstrap/js/bootstrap.min.js></script>
<script src=/plugins/fancybox/jquery.fancybox.min.js></script>
<script src=/plugins/goodshare/goodshare.min.js></script>
<script src=/plugins/fuse/fuse.min.js></script>
<script src=/plugins/jquery-mark/jquery.mark.min.js></script>
<script src=/js/main.js></script>
<script src=/js/search.js></script></body></html>