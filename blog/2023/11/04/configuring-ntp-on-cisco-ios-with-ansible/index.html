<!doctype html><html lang=en><head><meta name=google-site-verification content="NTPifZ1gNpp6HSoC60ErvHiUUor86ZXg4yHtlpk9lwU"><title>Andrea Dainese > Configuring NTP on Cisco IOS with Ansible</title><meta charset=utf-8><meta name=author content="Andrea Dainese"><meta name=description content="This article serves as an example to explore different strategies for configuring a feature on network devices using Ansible. Specifically, we will focus on configuring NTP on Cisco IOS devices, although the discussions here can be generalized."><meta name=generator content="Hugo 0.115.3"><meta name=“robots” content="“noarchive”"><meta name=“robots” content="“notranslate”"><meta name=robots content="noimageindex"><meta property="og:title" content="Configuring NTP on Cisco IOS with Ansible"><meta property="og:description" content="This article serves as an example to explore different strategies for configuring a feature on network devices using Ansible. Specifically, we will focus on configuring NTP on Cisco IOS devices, although the discussions here can be generalized."><meta property="og:type" content="article"><meta property="og:url" content="https://www.adainese.it/blog/2023/11/04/configuring-ntp-on-cisco-ios-with-ansible/"><meta property="og:image" content="https://www.adainese.it/images/vendors/ansible.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-11-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-04T00:00:00+00:00"><meta property="og:site_name" content="Andrea Dainese"><meta name=twitter:card content="summary"><meta name=twitter:site content="@adainese"><meta name=twitter:image content="https://www.adainese.it/images/vendors/ansible.png"><meta name=twitter:title content="Andrea Dainese > Configuring NTP on Cisco IOS with Ansible"><meta name=twitter:description content="This article serves as an example to explore different strategies for configuring a feature on network devices using Ansible. Specifically, we will focus on configuring NTP on Cisco IOS devices, although the discussions here can be generalized."><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed for blog" href=/blog/index.xml><link rel=dns-prefetch href=https://www.googletagmanager.com><link href=https://www.googletagmanager.com rel=preconnect crossorigin><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=stylesheet type=text/css href=/plugins/fontawesome/css/all.min.css><link rel=stylesheet type=text/css href=/plugins/fancybox/jquery.fancybox.min.css><link rel=stylesheet type=text/css href=/fonts/opensans/opensans.css><link rel=stylesheet href=/css/style.min.db8a68dfac8ad6ed301e5f04872a83daee269833ef371fd9ec9475b745de14e5.css integrity="sha256-24po36yK1u0wHl8EhyqD2u4mmDPvNx/Z7JR1t0XeFOU="><link rel=stylesheet href=/css/print.min.a3802e6b39df8780c4980151b47550b34687a140e148c71342fb463b5322e6b1.css media=print integrity="sha256-o4Auaznfh4DEmAFRtHVQs0aHoUDhSMcTQvtGO1Mi5rE="></head><body><button type=button class="mobile-nav-toggle d-lg-none" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button><header id=header class=fixed-top><div class="container d-flex"><div class="logo mr-auto"><h1><a href=/#><span>Andrea</span> Dainese</a></h1></div><nav class="nav-menu d-none d-lg-block"><ul><li><a href=/#>Home</a></li><li><a href=/#about>About</a></li><li class=active><a href=/blog>Blog</a></li><li><a href=/categories>Categories</a></li><li><a href=https://www.patreon.com/adainese target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><form class="form-inline ml-2" action=/search><div class="input-group mb-3"><input id=search-query type=text class=form-control placeholder=Search... name=s aria-label="Search within the website" aria-describedby=basic-addon2><div class=input-group-append><button class="btn btn-outline-primary" type=submit aria-label=Search>
<i class="fa fa-search"></i></button></div></div></form></li></ul></nav></div></header><div id=page-header><div class=home-overlay></div><div class=container><div class=row><div class=col-12><div class="page-header-size text-center"><h1>Configuring NTP on Cisco IOS with Ansible</h1></div></div></div></div></div><main id=main><div class=blogpost-single><div class=container><div class=row><div class="col-xs-12 col-sm-12 col-md-4 d-print-none"><div class=blogpost-nav><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Table of contents</h4><div class=toce><nav id=TableOfContents><ul><li><a href=#using-the-ciscoiosios_ntp_global-module>Using the <code>cisco.ios.ios_ntp_global module</code></a></li><li><a href=#using-the-generic-module>Using the generic module</a></li><li><a href=#saving-the-configuration>Saving the configuration</a></li><li><a href=#optimizing-performance>Optimizing performance</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Latest posts</h4><div class=recent-post><div class=recent-post-img><a href=/blog/2026/01/11/filtering-cisco-api-output/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2026/01/11/filtering-cisco-api-output/>Filtering Cisco API Output</a><br><i class="fa fa-calendar"></i>
January 11, 2026</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2026/01/04/finding-cisco-aci-classes-with-visore/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2026/01/04/finding-cisco-aci-classes-with-visore/>Finding Cisco ACI Classes with Visore</a><br><i class="fa fa-calendar"></i>
January 04, 2026</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/12/28/cisco-aci-classes/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/12/28/cisco-aci-classes/>Cisco ACI Classes</a><br><i class="fa fa-calendar"></i>
December 28, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/12/21/first-approach-to-cisco-aci-apis/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/12/21/first-approach-to-cisco-aci-apis/>First Approach to Cisco ACI APIs</a><br><i class="fa fa-calendar"></i>
December 21, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/12/14/automating-user-management-with-n8n-and-ai-agents/><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/12/14/automating-user-management-with-n8n-and-ai-agents/>Automating user management with n8n and AI Agents</a><br><i class="fa fa-calendar"></i>
December 14, 2025</p></div></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Categories</h4><div class=recent-post><div class=recent-post-img><a href=/categories/automation><img class="img-fluid rounded" src=/images/categories/automation.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/automation>Automation</a><br><i class="fa fa-blog"></i> 176 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/learning-paths><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/learning-paths>Learning paths</a><br><i class="fa fa-blog"></i> 140 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ciso><img class="img-fluid rounded" src=/images/categories/ciso.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ciso>CISO</a><br><i class="fa fa-blog"></i> 23 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/personal-security><img class="img-fluid rounded" src=/images/categories/personal-security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/personal-security>Personal Security</a><br><i class="fa fa-blog"></i> 22 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/security><img class="img-fluid rounded" src=/images/categories/security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/security>Security</a><br><i class="fa fa-blog"></i> 20 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/notes><img class="img-fluid rounded" src=/images/categories/notes.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/notes>Notes</a><br><i class="fa fa-blog"></i> 19 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/infrastructure><img class="img-fluid rounded" src=/images/categories/infrastructure.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/infrastructure>Infrastructure</a><br><i class="fa fa-blog"></i> 12 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ot-ics><img class="img-fluid rounded" src=/images/categories/ot-ics.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ot-ics>OT/ICS</a><br><i class="fa fa-blog"></i> 5 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/books><img class="img-fluid rounded" src=/images/categories/books.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/books>Books</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/unetlab><img class="img-fluid rounded" src=/images/categories/unetlab.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/unetlab>UNetLab</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/writeup><img class="img-fluid rounded" src=/images/categories/writeup.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/writeup>Write-up</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/osint><img class="img-fluid rounded" src=/images/categories/osint.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/osint>OSInt</a><br><i class="fa fa-blog"></i> 2 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/life><img class="img-fluid rounded" src=/images/categories/life.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/life>My life</a><br><i class="fa fa-blog"></i> 1 posts</p></div></div></div></div></div></div><div class="col-xs-12 col-sm-12 col-md-8 blogpost-container"><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><article><div class=blogpost-single-content><h2>Configuring NTP on Cisco IOS with Ansible</h2><div class=blogpost-single-meta><div><i class="fa fa-user"></i> Andrea Dainese</div><div><i class="fa fa-calendar"></i>
November 04, 2023</div><div class=tag-meta><i class="fa fa-folder"></i>
<a href=/categories/automation/ title="All posts under Automation">Automation</a></div></div><div class=entry-content><div><a data-fancybox=gallery href=/images/vendors/ansible.webp><img class="img-fluid w-25 rounded shadow float-right" src=/images/vendors/ansible.webp alt="Post cover"></a></div><p>This article serves as an example to explore different strategies for configuring a feature on network devices using <a href=https://www.ansible.com/ title=Ansible>Ansible</a>. Specifically, we will focus on configuring NTP on Cisco IOS devices, although the discussions here can be generalized.</p><p>As mentioned, in general, there are two possible approaches:</p><ul><li>we can use specific Ansible modules, specifically <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_ntp_global_module.html title=cisco.ios.ios_ntp_global>cisco.ios.ios_ntp_global</a></code>;</li><li>we can use the generic configuration module <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_config_module.html title=cisco.ios.ios_config>cisco.ios.ios_config</a></code>.</li></ul><p>The two approaches are radically different:</p><ul><li>Using specific modules delegates all checks regarding idempotence, integrity, and cleanliness of the configuration to the module itself. While the module handles all the work, we need to ensure it behaves correctly (bug-free), supports all the settings we need, and especially, we cannot make any optimizations.</li><li>Using generic configuration modules allows us flexibility to configure any necessary parameter (very useful in complex configurations involving, for example, BGP, MPLS, QoS&mldr;), but requires us to correctly manage idempotence, cleanliness, and especially optimization.</li></ul><p>Let&rsquo;s see in detail how to configure NTP on Cisco IOS in the two described modes, starting from a list of NTP peers defined at the configuration level:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ntp_peers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>0.</span><span style=color:#ae81ff>pool.ntp.org</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>1.</span><span style=color:#ae81ff>pool.ntp.org</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>2.</span><span style=color:#ae81ff>pool.ntp.org</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>3.</span><span style=color:#ae81ff>pool.ntp.org</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>4.</span><span style=color:#ae81ff>pool.ntp.org</span>
</span></span></code></pre></div><h2 id=using-the-ciscoiosios_ntp_global-module>Using the <code>cisco.ios.ios_ntp_global module</code></h2><p>When using modules that we are not familiar with, it is always good practice to:</p><ul><li>review the module documentation;</li><li>perform tests to verify behavior in all possible scenarios;</li><li>ensure, after any upgrades, that the behavior has changed.</li></ul><p>Reviewing the documentation immediately reveals that the module wants the list of peers in a different format from ours. Since all parameters are standardized, from a design point of view, it makes sense to keep the list of NTP peers as seen previously, moving the &ldquo;translation&rdquo; of the format into the role:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>ansible.builtin.set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ntp_peers_config_list</span>: <span style=color:#e6db74>&#34;{{ ntp_peers_config_list|default([]) + [{&#39;peer&#39;: item}] }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ ntp_peers }}&#34;</span>
</span></span></code></pre></div><p>We will immediately notice that we are introducing a performance problem that we will address later.</p><p>At this point, we have a list of NTP peers in the correct format, all we have to do is invoke the module:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_ntp_global</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>peers</span>: <span style=color:#e6db74>&#34;{{ ntp_peers_config_list }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>replaced</span>
</span></span></code></pre></div><p>The only open point is the <code>state</code> parameter, which can take different values:</p><ul><li><code>merged</code>: the added configuration is added to what is already present (any existing NTP peers will not be removed).</li><li><code>replaced</code> and <code>overridden</code>: the added configuration replaces what is already present (any existing NTP peers will be removed).</li><li><code>deleted</code>: the existing configuration will be removed, and nothing will be configured.</li></ul><p>In this case, the <code>replaced</code> and <code>overridden</code> modes are identical. In general, behavior should always be checked with the appropriate documentation, but we can say that:</p><ul><li><code>replaced</code>: individual configurations present in the device and not expected are first removed and then correctly reinserted.</li><li><code>overridden</code>: all the configuration present in the device is deleted and then correctly reinserted.</li></ul><p>If in the <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_config_module.html title=cisco.ios.ios_config>cisco.ios.ios_config</a></code> module the behavior is identical, in the <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_acls_module.html title=cisco.ios.ios_acls>cisco.ios.ios_acls</a></code> module the behavior differs because ACLs are composed of sub-blocks:</p><ul><li><code>replaced</code> in this case removes individual ACEs (access control entries) from each ACL, and then inserts the correct ACEs.</li><li><code>overridden</code> in this case deletes the ACLs and then reinserts them correctly.</li></ul><p>There are then three values that will not modify the state of the configuration and that can be used for other elaborations, such as debugging:</p><ul><li><code>rendered</code>: the configuration that would be added is saved in output in the <code>rendered</code> key.</li><li><code>gathered</code>: the configuration present on the device is read and saved in output in JSON format using the <code>gathered</code> key.</li><li><code>parsed</code>: like <code>gathered</code> but the input is not the device configuration, but what is present in the <code>running_config</code> variable. The output is saved in JSON format using the <code>parsed</code> key.</li></ul><p>Given the complexity of the configurations that can be performed on network devices, it should be clear why it is important to verify that the module behaves as expected, supports the configurations we need, and that the behavior remains the same in case of updates.</p><p>The configuration is not saved automatically at the end of the task: it is clear that in a playbook that invokes dozens of different modules, if the configuration were saved after each task, we would have a possible performance problem. Furthermore, we must bear in mind that, since we are effectively doing text scraping, the execution of each module involves reading the configuration using the <code>show running-config</code> command: this can generate an additional performance problem.</p><h2 id=using-the-generic-module>Using the generic module</h2><p>The generic module <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_config_module.html title=cisco.ios.ios_config>cisco.ios.ios_config</a></code> gives us complete freedom to add and remove any configuration we can think of. It remains up to us, if we deem it appropriate, to manage idempotence, correctness, and efficiency.</p><p>The <code><a href=https://docs.ansible.com/ansible/latest/collections/cisco/ios/ios_config_module.html title=cisco.ios.ios_config>cisco.ios.ios_config</a></code> module:</p><ul><li>Like in the previous case, it automatically executes the <code>show running-config</code> command. The output will be used to verify if certain commands already exist and thus heavily influences the <code>changed</code> state. For example, if we configure <code>int e0/0</code>, with each execution Ansible will re-enter the configuration because <code>interface Ethernet0/0</code> is present instead in the configuration. We deduce that we must be extremely precise in the commands we execute. With each change, Ansible will notify us with the following message: To ensure idempotency and correct diff the input configuration lines should be similar to how they appear if present in the running configuration on the device.</li><li>Unlike the previous case, the configuration can be read from the <code>running_config</code> variable, allowing us to optimize complex playbooks.</li><li>Due to how Cisco devices work, default commands are not shown in the configuration. Inserting, or better restoring a parameter to its default behavior means that Ansible will always declare the <code>changed</code> state. This is because the inserted (default) command will never be checked as present in the configuration. Therefore, we must manually manage this event.</li><li>Due to how Cisco devices work, I cannot declare a list of NTP peers, but I have to add the missing ones and remove the necessary ones. Unlike the previous case, it is up to us to properly implement this behavior.</li></ul><p>A simplified approach that I call &ldquo;blind&rdquo; involves executing commands anyway, even if not necessary, such as removing a specific NTP peer. This approach certainly has the advantage of being simple and immediate, but requires anticipating all possible cases and always results in the <code>changed</code> state, thus nullifying the possibility of verifying &ldquo;compliance&rdquo;.</p><p>That said, our playbook must:</p><ul><li>add the NTP peers that are present in the list but not present in the device configuration;</li><li>remove the NTP peers that are present in the device configuration but not in the list.</li></ul><p>The first part is extremely simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lines</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;ntp peer {{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replace</span>: <span style=color:#ae81ff>line</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>save_when</span>: <span style=color:#ae81ff>never</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ ntp_peers }}&#34;</span>
</span></span></code></pre></div><p>There are two parameters to pay attention to:</p><ul><li><code>replace</code>: takes <code>line</code> (default) or <code>block</code> as a value and defines how the configuration is applied. With line, individual commands not present in the configuration are sent, with <code>block</code>, all commands are sent even if one differs from the configuration.</li><li><code>save_when</code>: defines when the configuration is saved, and the values can be: <code>always</code>, <code>never</code> (default), <code>modified</code>, <code>changed</code>.</li></ul><p>We now need to remove the no longer necessary NTP peers. To do this, we must first extract all configured NTP servers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>ansible.builtin.set_fact</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>current_ntp_peers</span>: <span style=color:#e6db74>&#34;{{ running_config | regex_findall(&#39;^ntp peer .*$&#39;, multiline=True) | regex_replace(&#39;ntp peer &#39;, &#39;&#39;)}}&#34;</span>
</span></span></code></pre></div><p>Finally, we can remove the unnecessary NTP servers, i.e., those that are configured but not present in the <code>ntp_peers</code> list:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lines</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;no ntp peer {{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>running_config</span>: <span style=color:#e6db74>&#34;{{ running_config }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replace</span>: <span style=color:#ae81ff>line</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>save_when</span>: <span style=color:#ae81ff>never</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ current_ntp_peers }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>item not in ntp_peers</span>
</span></span></code></pre></div><p>This approach allows us ample freedom but at the same time proves complex to manage nested block configurations (such as routing).</p><h2 id=saving-the-configuration>Saving the configuration</h2><p>At this point, the devices will have the desired configuration, but it is not saved. To do this, we have three approaches:</p><ul><li><code>handler</code>: which allows us to &ldquo;trigger&rdquo; a task if it results in the <code>changed</code> state. This mode is the simplest but has a problem: if the playbook stops, there is no guarantee that the next execution will still report a <code>changed</code> state and consequently trigger the <code>handler</code> task.</li><li>Always save the configuration at the end of the playbook: this approach is the simplest, however, for each execution, the configuration will be saved, and we will never have visibility of when the router configuration actually needs to be saved.</li><li>Check if the <code>running</code> and <code>startup</code> configurations are different and, in this case, actually save the configuration.</li></ul><p>Let&rsquo;s see first how to save the configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_command</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>: <span style=color:#ae81ff>write memory</span>
</span></span></code></pre></div><p>We used <code>write memory</code> instead of the modern <code>copy running-config startup-config</code> because the former does not require confirmation, while the latter does: managing the confirmation would be an unnecessary complexity.</p><p>This task can be configured within the <code>post_tasks</code>, or called as a <code>handler</code> by all tasks that potentially modify the configuration.</p><p>The tasks become:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lines</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;ntp peer {{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replace</span>: <span style=color:#ae81ff>line</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>save_when</span>: <span style=color:#ae81ff>never</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ ntp_peers }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>notify</span>: <span style=color:#ae81ff>SAVING CONFIGURATION</span>
</span></span></code></pre></div><p>While the task to save the configuration must be configured as a <code>handler</code>, preferably within the <code>handlers/main.yml</code> file.</p><h2 id=optimizing-performance>Optimizing performance</h2><p>We must now optimize the configuration saving, only performing it if necessary. Procedurally, this means comparing the <code>startup-config</code> with the <code>running-config</code>, and, in case of differences, performing the save.</p><p>Let&rsquo;s see step by step how to proceed. Initially, we need to read the updated <code>startup-config</code> and <code>running-config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>cisco.ios.ios_command</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>: <span style=color:#ae81ff>show startup-config</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>register</span>: <span style=color:#ae81ff>show_startup_config_output</span>
</span></span><span style=display:flex><span>-  <span style=color:#f92672>cisco.ios.ios_command</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>: <span style=color:#ae81ff>show running-config</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>register</span>: <span style=color:#ae81ff>show_running_config_output</span>
</span></span></code></pre></div><p>We must then verify if the two configurations differ, net of some lines.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>ansible.utils.fact_diff</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>before</span>: <span style=color:#e6db74>&#34;{{ show_startup_config_output.stdout[0] }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>after</span>: <span style=color:#e6db74>&#34;{{ show_running_config_output.stdout[0] }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>plugin</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>skip_lines</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;^Current configuration.*&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;^Building configuration.*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>config_differ</span>
</span></span></code></pre></div><p>We can then condition the saving of the configuration on the result of the previous task using <code>config_differ.changed</code>.</p><p>A note of caution: the save process should only be done if the playbook is not in check mode (<code>-C</code>). Finally, we must remember that the save task should also be executed if the playbook is run including only some <code>tags</code>.</p><h2 id=conclusions>Conclusions</h2><p>Despite everything, it is preferable to use specialized modules, if bug-free and if they implement all the features we need. This also applies if we encounter performance problems. However, in my experience, it will often be necessary to use the generic configuration module to configure specific details not foreseen.</p></div></div></article><div class=clear></div></div></div></div></div></div></div></main><footer class=d-print-none><div class=footer-profile><div class=container id=contact><div class=row><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h2><span>Andrea</span> Dainese</h2></div><p>For information, collaborations, proposals, requests for help, donations, use one of the following channels; email is preferred.</p><div class=footer-icons><ul><li><a href=https://www.patreon.com/adainese title="Support me" target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.linkedin.com/in/adainese/ title="LinkedIn profile" target=_blank rel=noreferrer><i class="fab fa-linkedin-in"></i></a></li><li><a href=https://twitter.com/adainese title="Twitter profile" target=_blank rel=noreferrer><i class="fab fa-twitter"></i></a></li><li><a href=mailto:andrea@adainese.it title="Secure email" target=_blank rel=noreferrer><i class="fa fa-envelope"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 title=Podcast target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><a href=https://github.com/dainok/ title="GitHub repositories" target=_blank rel=noreferrer><i class="fab fa-github"></i></a></li><li><a href=/blog/index.xml title="RSS Feed" target=_blank><i class="fa fa-rss"></i></a></li></ul></div></div><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h4>Past events</h4></div><div class=footer-content><ul><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20240305-cisco-aci-automation.pdf title="View slides" target=_blank rel=noreferrer>SDN: Software Defined Now</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20231122-cybercrime.pdf title="View slides" target=_blank rel=noreferrer>Cybercrime</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220901-bgp-attack-scenarios.pdf title="View slides" target=_blank rel=noreferrer>BGP attack scenarios</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220317-approaching-ot-ics-security.pdf title="View slides" target=_blank rel=noreferrer>Approaching OT/ICS Security</a> (with <a href=https://www.festocte.it/eventi/industry_4_0/17-03-2022/webinar_la_cybersecurity_nelle_reti_di_fabbrica_P/>Festo Academy</a>)</li><li><a href="https://www.youtube.com/watch?v=sjQZghTkHkA" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200922-cyberrange.pdf title="View slides" target=_blank rel=noreferrer>Cyber Range: Analyzing a Cyber Attack</a></li><li><a href="https://www.youtube.com/watch?v=-PWtGaS28dk" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200623-clubitfvg-securing-ot-ics-plants.pdf title="View slides" target=_blank rel=noreferrer>Securing OT/ICS plants</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20190226-automation-for-cisco-netops.pdf title="View slides" target=_blank rel=noreferrer>Automation for Cisco NetOps</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181107-ciscon-sdn-complexity-and-tco-looking-for-an-easy-way.pdf title="View slides" target=_blank rel=noreferrer>SDN, Complexity and TCO</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181003-nts-protection-and-visibility-for-enterprise-networks.pdf title="View slides" target=_blank rel=noreferrer>Protection and visibility for enterprise networks</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20141106-festival-ict-why-wan-accelerators-still-matter.pdf title="View slides" target=_blank rel=noreferrer>Why WAN AccelerAtors (still) matter?</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20130918-festival-ict-designing-an-hybrid-data-center-infrastructure.pdf title="View slides" target=_blank rel=noreferrer>Designing an Hybrid Data Center Infrastructure</a></li></ul></div></div><div class="d-none d-md-block col-md-4"><div class=footer-head><h4>Competencies</h4></div><div class=footer-slides><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/security-125x100.webp alt="Incident Response"><div class=overlay>Incident Response</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/ciso-125x100.webp alt=Advisor><div class=overlay>Advisor</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/osint-125x100.webp alt="Open Source Intelligence (OSINT)"><div class=overlay>Open Source Intelligence (OSINT)</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/infrastructure-125x100.webp alt="System Integration / Automation"><div class=overlay>System Integration / Automation</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/writeup-125x100.webp alt="Training / Education / Cyber Range"><div class=overlay>Training / Education / Cyber Range</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/personal-security-125x100.webp alt="Personal Security"><div class=overlay>Personal Security</div></div></div></div></div></div></div></div><div class=footer-copyright><div class=container><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><div class=text-center>&copy; Copyright <strong>Andrea Dainese</strong>. All Rights Reserved</div><div class=text-center>Designed by <a href=https://bootstrapmade.com/ title=BootstrapMade target=_blank rel=noreferrer>BootstrapMade</a></div></div></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script>
<script src=/plugins/bootstrap/js/bootstrap.min.js></script>
<script src=/plugins/fancybox/jquery.fancybox.min.js></script>
<script src=/plugins/goodshare/goodshare.min.js></script>
<script src=/plugins/fuse/fuse.min.js></script>
<script src=/plugins/jquery-mark/jquery.mark.min.js></script>
<script src=/js/main.js></script>
<script src=/js/search.js></script></body></html>